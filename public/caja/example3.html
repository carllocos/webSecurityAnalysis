<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>Controlled Network Access</title>

    <!-- Load required caja module-->
    <script type="text/javascript" src="http://caja.appspot.com/caja.js">
    </script>


</head>

<body>
    <div class="">
        <h3>Controlled Network Access Example</h3>

        <p>
            In this example we show a guest (powder blue background color) that has resicted network access. The network access is limited to two
            requests; 1)image (through img tag) and 2) the joke text (through a XMLHttpRequest).
        </p>
        <p>
            After two network access, any other attempt to access the network fails. The guest code attempts a third network access through another XMLHttpRequest which fails. A "XMLHttpRequest fail" is written on the dom to illustrate this"
        </p>
        <br>
        <div id="guest"></div>



        <div id="log"></div>

        <!-- Comment script for behaviour without Caja -->

        <script type="text/javascript">
            caja.whenReady((ev) => { console.log("Ready!") })
            caja.initialize({
                cajaServer: 'http://caja.appspot.com/',
                debug: true
            })

            const EMBED = document.getElementById('guest')
            const MAX_REQUESTS = 2
            var requests_made = 0

            const NETWORK_POLICY = {
                rewrite: (uri) => {
                    if (requests_made < MAX_REQUESTS &&
                        /http:\/\/localhost:3030/.test(uri)) {
                        requests_made += 1;
                        return uri;
                    }
                    return undefined
                }
            };
            const guestURL = 'http://localhost:3030/caja/example3_guest.html'
            caja.load(EMBED, NETWORK_POLICY, (frame) => {

                caja.markCtor(XMLHttpRequest);
                caja.grantMethod(XMLHttpRequest.prototype, "onreadystatechange");
                caja.grantMethod(XMLHttpRequest.prototype, "open");
                caja.grantMethod(XMLHttpRequest.prototype, "send");
                caja.grantReadWrite(XMLHttpRequest.prototype, "onreadystatechange");
                caja.grantRead(XMLHttpRequest.prototype, "readyState");
                caja.grantRead(XMLHttpRequest.prototype, "status");
                caja.grantRead(XMLHttpRequest.prototype, "responseText");

                var hostAPI = {
                    newXtr: () => {
                        if (requests_made < MAX_REQUESTS) {
                            requests_made += 1;
                            return new XMLHttpRequest();
                        }else{
                            logOnDom("XMLHttpRequest fail");
                        }
                    },
                }

                caja.markReadOnlyRecord(hostAPI);
                caja.markFunction(hostAPI.newXtr);
                var tamedAPI = caja.tame(hostAPI);
                frame.code(guestURL, 'text/html')
                    .api({ host: tamedAPI })
                    .run()
            })


            function logOnDom(t){
                document.getElementById("log").innerHTML = t;
            }
        </script>
</body>

</html>